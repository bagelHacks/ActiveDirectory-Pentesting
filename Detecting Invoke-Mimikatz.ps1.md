# Detecting Invoke-Mimikatz.ps1 

I had to configure the AD lab to have advanced audit policy configured. This enabled the logging the needed events for this attack. 

The following configurations were set for advances auditing.

![[Pasted image 20210906142301.png]]

## Summary 

- Mimikatz credential dump attacks trigger 4656 (handle to an object was requested) and 4663 (An attempt was made to access an object) event logs. 
- Advanced auditing object access needs to be configured
- Process name of powershell + Object of lsass.exe + regular user account is highly suspicious

## Detection

I used a local admin account to dump lsass memory and immediately used the following command to see the most recent windows security logs:

Get-EventLog -LogName Security -Newest 10

![[Pasted image 20210906015536.png]]


### The following windows events were triggered
- 4663 An attempt was made to access an object
- 4656 A handle to an object was requested
- 4658 The handle to an object was closed
- 4690 An attempt was made to duplicate a handle to an object
- 4688 A new process has been created

- The important ones for detection are 4663 and 4656 

### 4663

Get-winevent -Logname 'Security' | ? {$_.id -eq 4663} | select-object -First 1 -ExpandProperty Message

![[Pasted image 20210906135356.png]]

### Important Fields
	- Account Name: Jhalpert. 
		- Notice that it is a user attempting to read lsass and not a computer account
	- Object Name: lsass.exe 
		- Normal 4663 logs attempting to access lsass.exe is related to AV
	- Process Name: powershell.exe
		- It is strange for powershell to access lsass memory

### The following are examples of normal 4663 event logs

![[Pasted image 20210906150056.png]]

![[Pasted image 20210906150418.png]]

### 4656 

Get-winevent -Logname 'Security' | ? {$_.id -eq 4646} | select-object -First 1 -ExpandProperty Message

![[Pasted image 20210906135427.png]]

### Important Fields
	- Account Name: jhalpert
		- Notice that account name is not a $ account 
	- Object Name: lsass.exe
		- Most 4656 event logs target objects that are not lsass
	- Process Name:  powershell.exe
		- Powershell.exe accessing lsass is suspicious
		
		
### The following are examples of regular 4656 event logs

![[Pasted image 20210906145830.png]]

![[Pasted image 20210906150534.png]]

