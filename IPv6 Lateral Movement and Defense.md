# IPv6 Lateral Movement and Defense
  
 I learned these techniques from Heath Adams Practical Ethical Hacking Course:
 
 https://academy.tcm-sec.com/p/practical-ethical-hacking-the-complete-course
 
If IPv6 is turned on and IPv4 is being used in the network, it could be possible that DNS for IPv6 is not configured

In this lab, I will abuse this setting. Similar to LLMNR poisoning, if a malicious actor can get access to the network, they can start a listener for IPv6 requests. This attack can potentially allow somebody to login to the domain controller by simply being on the same network. 

## IPv6 Attack Flow

By default, Windows 10 workstations broadcast IPv6 requests that say "who has my IPv6 DNS configuration?" through dhcpv6 . My attacker machine will listening on the network for these requests and say "I have the configuration and use me as your ipv6 DNS server!"

Since windows prefers ipv6 over ip4, it will use my attack machine for A and AAAA DNS records (IPV4 and IPv6)

The victim will immediately start asking for the wpad.dat file which my Kali will provide. This will set my device as a proxy that the victim has to authenticate before reaching the internet.

## IPv6 Attack in Action

#### Start listener 

mitm6 will be used on the attack machine to listen for the IPv6 requests.

Mitm6 -d dunder-mifflin.local

![image](https://user-images.githubusercontent.com/90155329/132542212-eb2d4464-6cfb-4d44-9fc1-a59e0fb5c53e.png)

#### Setup relay

After mitm6 receives the request, ntlmrelay will be used to relay the attack.

python3 nelmrelayx.py -6 -t ldaps://192.168.138.167 -wh fakewpad.dunder-mifflin.local -l lootme

- 6 = Use IPv6
- t = target (Domain Controller)
- l = directory to dump the output files
- wh = Name of the fake wpad file we will provide. This is used to configure proxy settings and can be abused to have the victim send it's NTLM hash

![image](https://user-images.githubusercontent.com/90155329/132542263-111b8cbc-e897-4455-b378-f3c5361121e8.png)

### Wait for DHCPv6 Configuration Request

These requests happen by default, typically when a computer restarts.

Eventually, one of the users (Pam Beesly) restarts her computer. My attack machine listened to the DHCPv6 request from her computer and said "Go to the attack machine for your DNS". 

When Pam's computer started using the attack machine for DNS, it requested the wpad file for Proxy configurations from the malicious attack machine. This wpad file required NTLM authentication for web requests, so Pam's computer authenticated to the attack machine.

The attack machine took the authentication and sent it to the Domain controller. After this, it was able to login and enumerate privileges for Pam's computer. 

![image](https://user-images.githubusercontent.com/90155329/132542299-dfcc5c98-44e5-4d60-b4f2-181f7d06dac7.png)

This dumped all the enumerated information to the lootme directory

![image](https://user-images.githubusercontent.com/90155329/132542342-b5d99642-3361-443c-916c-c0a9b1fde8d6.png)

If the user that connects to my attack machine is a Domain Admin or Enterprise Admin, ntlm will attempt to create a new user with the elevated credentials. An ACE will also be created for this account.

![image](https://user-images.githubusercontent.com/90155329/132542385-77a0a690-6087-4588-9835-4520a2409668.png)

![image](https://user-images.githubusercontent.com/90155329/132542418-8086a88d-d734-4ca9-90aa-202c5c35d7e9.png)

## Defense 

Fox-it has listed reccomendations for this attack below:

https://blog.fox-it.com/2017/05/09/relaying-credentials-everywhere-with-ntlmrelayx/

![image](https://user-images.githubusercontent.com/90155329/132542463-074153d1-f0dc-459b-95a9-23235ac49edb.png)
