# PreAuth Disabled

### Kerberos Recap

Kerberos is an authenticaiton mechanism used to access different services on a domain. 
When a user needs access to a services, it starts by requesting a ticket granting ticket (TGT) fromt the key distribution center (KDC) by providing a timestamp encrypted with the user's credential. The KDC, receives the request, validates it and responds with a TGT. This TGT can the be used to request a Ticket granting service (TGS) ticket. 

### PreAuth Disabled

If a user account has preauthentication disabled, any domain account can request a TGT ticket on behalf of the user without providing credentials. This TGT will contain a hash of the user which can then be cracked offline.


### To exploit this, I disabled preauthentication for the pbeesly user. 

This can be done from "Active Directory Users and Computers" in Server Manager on the domain controller.

![image](https://user-images.githubusercontent.com/90155329/132273701-2102a4f6-77c5-433c-ba82-a7165073bc4a.png)

Now that this configuration is complete, I can hunt down this user with different tools.

### Finding PreAuth Disabled users with AsRepRoast.ps1

https://github.com/HarmJ0y/ASREPRoast


Invoke-AsRepRoast # Enumerates users with preauthentication disabled

![image](https://user-images.githubusercontent.com/90155329/132273742-e172b4ff-1aec-47fb-91ac-2d32b1643f45.png)

Get-AsRepHash -Username pbeesly # Request a TGT for pbeesly and extract the hash 

![image](https://user-images.githubusercontent.com/90155329/132273767-d42206cc-05c8-4a4f-a09c-c52bef671dfd.png)

I wanted to see what the event log looked like from the Domain Controller and noticed that it is not logging 4768 (A Kerberos authentication ticket was requested). 

![image](https://user-images.githubusercontent.com/90155329/132273812-5961547c-9379-4895-ac63-7389a03a3119.png)

To configure this, I had to go into Group Policy Management, and configure the "Default Domain Controllers Policy"

Computer Configuration > Windows Settings > Security Settings > Advanced Audit Policy > Audit Policies > Logon/Logoff > Audit Kerberos Authentication Service 

![image](https://user-images.githubusercontent.com/90155329/132273830-b106e63c-187d-4564-b287-1f1894c3e2ef.png)

After this configuration, I was able to see the malicious TGT request

![image](https://user-images.githubusercontent.com/90155329/132273853-2578b8d9-2e66-4348-974f-559f0b7e14c7.png)

This windows event log is very difficult to detect. The only suspicious field is that the Client Address is 192.168.138.170, the IP address of the dschrute-computer. 

Hashcat can be used to crack the hash from earlier.

#### hashcat64.exe -m 18200 hash.txt rockyou.txt -O

![image](https://user-images.githubusercontent.com/90155329/132273880-fee8cc76-f28b-49cf-ac49-5870b29c4f09.png)

From dschrute's computer, I was able to powershell remote into pbeesly's computer using her credentials. If a domain admin was logged into pbeesly's computer earlier, I can potentially escalate by dumping credentials. 

![image](https://user-images.githubusercontent.com/90155329/132273952-2183b12b-fe0c-47b6-a04d-d9c4ef04ad91.png)
