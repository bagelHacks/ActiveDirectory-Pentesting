# Detecting Invoke-Mimikatz.ps1 LSASS Dumping

I had to configure the AD lab to have advanced audit policy configured. This enabled the logging needed for this attack. 

The following configurations were set for advances auditing.

![image](https://user-images.githubusercontent.com/90155329/132256933-a50d9d0f-e3f9-49a2-92dd-951b0736c3d9.png)


## Summary 

- Mimikatz credential dump attacks trigger 4656 (handle to an object was requested) and 4663 (An attempt was made to access an object) event logs. 
- Advanced auditing object access needs to be configured
- Process name of powershell + Object of lsass.exe + from a NonComputer$ account is highly suspicious

## Detection

I used a local admin account to dump lsass memory and immediately used the following command to see the most recent windows security logs:

Get-EventLog -LogName Security -Newest 10

![image](https://user-images.githubusercontent.com/90155329/132256963-8bf67770-97b4-441c-9068-e2a8dff963c1.png)



### The following windows events were triggered
- 4663 An attempt was made to access an object
- 4656 A handle to an object was requested
- 4658 The handle to an object was closed
- 4690 An attempt was made to duplicate a handle to an object
- 4688 A new process has been created

#### The important ones for detection are 4663 and 4656 

### 4663 - Malicious

Get-winevent -Logname 'Security' | ? {$_.id -eq 4663} | select-object -First 1 -ExpandProperty Message

![image](https://user-images.githubusercontent.com/90155329/132256993-1ed62c10-de37-4330-a490-4c3cd48353f3.png)


### Important Fields
	- Account Name: Jhalpert. 
		- Notice that it is a user attempting to read lsass and not a computer account
	- Object Name: lsass.exe 
		- Normal 4663 logs attempting to access lsass.exe is related to AV
	- Process Name: powershell.exe
		- It is strange for powershell to access lsass memory

### The following are examples of normal 4663 event logs

![image](https://user-images.githubusercontent.com/90155329/132257014-82b3ba2c-5da6-4143-960f-c3c5ad967389.png)
![image](https://user-images.githubusercontent.com/90155329/132257026-c092ea54-69d9-4966-8be1-16f6eabda4fb.png)


### 4656 - Malicious

Get-winevent -Logname 'Security' | ? {$_.id -eq 4646} | select-object -First 1 -ExpandProperty Message

![image](https://user-images.githubusercontent.com/90155329/132257041-749eb093-7c67-4c9c-9819-cdeb8fcb506b.png)

### Important Fields
	- Account Name: jhalpert
		- Notice that account name is not a $ account 
	- Object Name: lsass.exe
		- Most 4656 event logs target objects that are not lsass
	- Process Name:  powershell.exe
		- Powershell.exe accessing lsass is suspicious
		
		
### The following are examples of regular 4656 event logs

![image](https://user-images.githubusercontent.com/90155329/132257058-72de2019-f0ae-4ed4-bccd-3c04dbf87c98.png)
![image](https://user-images.githubusercontent.com/90155329/132257067-7f6c6c6e-86b1-4a44-95e1-38fd8c184a5e.png)


